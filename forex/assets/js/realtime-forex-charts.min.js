/**
 * Real-time FOREX Charts
 * ---------------------------------------------
 * Description: JavaScript plugin, which allows you to add interactive FOREX charts updated in real-time to your website. All major currency pairs are supported.
 * Version: 1.1.1, built on Thursday, February 16, 2017
 * Demo: http://webthegap.com/products/real-time-forex-charts/
 * Purchase: https://codecanyon.net/item/realtime-forex-charts/18913876?ref=financialtechnology
 * Like: https://www.facebook.com/webthegap/
 * Copyright (c) WebTheGap <mail@webthegap.com>. All rights reserved.
 */
"use strict";!function(e){function t(e,t){if("candlestick"==e.graph.chart.stockGraphs[0].type)return'<table class="candlestick-balloon"><tr><td>Open:</td><td>'+e.values.open+"</td></tr><tr><td>High:</td><td>"+e.values.high+"</td></tr><tr><td>Low:</td><td>"+e.values.low+"</td></tr><tr><td>Close:</td><td>"+e.values.close+"</td></tr></table>";var s=e.values.value,a=e.index>0?(s-e.graph.data[e.index-1].dataContext.valueClose).toFixed(5):0;return"<span>"+s+'</span> (<span class="'+(a>0?"rfc-price-up":a<0?"rfc-price-down":"")+'">'+a+"</span>)"}function s(e){var t,s={},a=[];"undefined"!=typeof e.graph?(s=e.graph.chart,a=e.graph.data):"undefined"!=e.balloon&&(s=e.balloon.chart,a=e.balloon.chart.chartData);var o=a.length;if("candlestick"==s.stockGraphs[0].type&&o&&"undefined"!=a[o-1].dataContext.dataContext.close)t=a[o-1].dataContext.dataContext.close;else if(a.length&&"undefined"!=a[o-1].dataContext.valueClose){var i=a[o-1].dataContext.valueClose,r=o>1&&i?i-a[o-2].dataContext.valueClose:0;t=i?i+" ("+r.toFixed(5)+")":""}return t||""}function a(){r&&console.log(arguments)}var o,i,r="undefined"!=typeof RealtimeForexChartsWordpressOptions&&RealtimeForexChartsWordpressOptions.debug,n="rfc-controls",l="rfc-asset-selector",c="rfc-type-selector",d="rfc-message",h="rfc-container",p="rfc-loader",u={},g={line:"Line",smoothedLine:"Smoothed line",step:"Step",smoothedLineArea:"Area",candlestick:"Candlestick"};e(document).ready(function(){function r(){for(var e in u)u.hasOwnProperty(e)&&k.append('<option value="'+e+'"'+(u[e]==C.defaultAsset?" selected":"")+">"+u[e]+"</option>");for(var t in g)g.hasOwnProperty(t)&&m.append('<option value="'+t+'"'+(g[t]==C.defaultChartType?" selected":"")+">"+g[t]+"</option>");o=new f(h,m.val(),b),i=new v(k.val(),o.instance,p,d),k.on("change",function(){i.changeAsset(k.val())}),m.on("change",function(){var e=m.val();o=new f(h,e,b),i.changeChartType(o.instance)})}function f(e,t,s){var o=this;this.construct=function(e,t,s){"candlestick"==t?(s.panels[0].stockGraphs[0].openField="open",s.panels[0].stockGraphs[0].highField="high",s.panels[0].stockGraphs[0].lowField="low",s.panels[0].stockGraphs[0].closeField="close",s.panels[0].stockGraphs[0].valueField="close",s.periodSelector.periods[s.periodSelector.periods.length-1].selected=!0,b.panels[0].stockGraphs[0].fillAlphas=1):"smoothedLineArea"==t?(t="smoothedLine",s.panels[0].stockGraphs[0].valueField="value",s.periodSelector.periods[0].selected=!0,b.panels[0].stockGraphs[0].fillAlphas=.2):(s.panels[0].stockGraphs[0].valueField="value",s.periodSelector.periods[0].selected=!0,b.panels[0].stockGraphs[0].fillAlphas=0),s.panels[0].stockGraphs[0].type=t,this.instance=AmCharts.makeChart(e,s)},this.init=function(){},this.dataUpdated=function(){},this.rendered=function(){a("Chart is rendered",o.instance.panels[0].stockGraphs[0].type)},this.construct(e,t,s),this.instance.addListener("dataUpdated",this.dataUpdated),this.instance.addListener("init",this.init),this.instance.addListener("rendered",this.rendered)}function v(t,s,o,r){var n=this;this.URL="wss://ws.binaryws.com/websockets/v3?app_id=2800",this.hitsoricalTicks=5e3,this.hitsoricalCandles=1e3,this.candlesGranularity=60,this.chart=s,this.$chartLoader=e("#"+o),this.$chartMessageId=e("#"+r),this.asset=t,this.getHistoricalTicks=function(){a("getHistoricalTicks",this.asset),this.ws.send(JSON.stringify({ticks_history:this.asset,style:"ticks",end:"latest",count:this.hitsoricalTicks}))},this.getHistoricalCandles=function(){a("getHistoricalCandles",this.asset),this.ws.send(JSON.stringify({ticks_history:this.asset,granularity:this.candlesGranularity,style:"candles",end:"latest",count:this.hitsoricalCandles}))},this.getLiveTicks=function(){a("getLiveTicks",this.asset),this.ws.send(JSON.stringify({ticks:this.asset}))},this.getLiveCandles=function(){a("getLiveCandles",this.asset),this.ws.send(JSON.stringify({ticks_history:this.asset,granularity:this.candlesGranularity,style:"candles",end:"latest",count:1,subscribe:1}))},this.stopDataSubscription=function(){var e="candlestick"==n.chart.panels[0].stockGraphs[0].type?"candles":"ticks";a("Stop subscription for "+e),this.ws.send(JSON.stringify({forget_all:e}))},this.connectionIsOpen=function(){return this.ws.readyState==WebSocket.OPEN||(a("WS state is not OPEN",this.ws.readyState),!1)},this.changeAsset=function(e){a("changeAsset",e),this.$chartLoader.show(),this.asset=e,this.connectionIsOpen()?(this.stopDataSubscription(),this.getHistoricalData()):this.connect()},this.changeChartType=function(e){this.$chartLoader.show(),this.connectionIsOpen()?(i.stopDataSubscription(),this.chart=e,this.getHistoricalData()):(this.chart=e,this.connect())},this.getHistoricalData=function(){"candlestick"==this.chart.panels[0].stockGraphs[0].type?this.getHistoricalCandles():this.getHistoricalTicks()},this.axisIndicator=function(){for(var e=n.chart.dataSets[0],t=0;t<n.chart.panels.length;t++){var a=n.chart.panels[t],o=e.dataProvider[e.dataProvider.length-1];"object"!=typeof a.valueAxes[0].guides&&(a.valueAxes[0].guides=[]);for(var i=0;i<a.stockGraphs.length;i++){var r=a.stockGraphs[i];void 0!==r.type&&"line"!==r.type&&"smoothedLine"!==r.type||(a.valueAxes[0].guides.pop(),a.valueAxes[0].guides.push({value:o[r.valueField],inside:!1,label:o[r.valueField],lineAlpha:0,color:s.chartCursorSettings.cursorColor}))}}},this.wsOnopen=function(e){a("WS connection established"),n.getHistoricalData()},this.wsOnclose=function(e){a("WS connection CLOSED")},this.wsOnmessage=function(e){var t=JSON.parse(e.data);if(a("ws.onmessage",t),"undefined"==typeof t.msg_type)return a("invalid response"),!1;if("history"==t.msg_type&&"undefined"!=typeof t.history.prices&&"undefined"!=typeof t.history.times){var s=t.history.times.length,o=t.history.prices.length;if(a("Number of ticks received",s,o),s&&o&&s==o){for(var i=[],r=0;r<s;r++)i.push({date:new Date(1e3*t.history.times[r]),value:parseFloat(t.history.prices[r])});a("chartData",i),n.chart.dataSets[0].dataProvider=i,n.chart.periodSelector.setDefaultPeriod(),n.chart.validateData(),n.$chartLoader.hide(),n.getLiveTicks()}}else if("candles"==t.msg_type&&"undefined"!=typeof t.candles&&"undefined"==typeof t.echo_req.subscribe){var l=t.candles.length;if(a("Number of candles received",l),l){for(var i=[],r=0;r<l;r++)i.push({date:new Date(1e3*t.candles[r].epoch),open:parseFloat(t.candles[r].open),high:parseFloat(t.candles[r].high),low:parseFloat(t.candles[r].low),close:parseFloat(t.candles[r].close)});a("chartData",i),n.chart.dataSets[0].dataProvider=i,n.chart.periodSelector.setDefaultPeriod(),n.chart.validateData(),n.$chartLoader.hide(),n.getLiveCandles()}}else if("tick"==t.msg_type&&"undefined"==typeof t.error&&"undefined"!=typeof t.tick.epoch&&"undefined"!=typeof t.tick.quote)n.chart.dataSets[0].dataProvider.push({date:new Date(1e3*parseInt(t.tick.epoch,10)),value:parseFloat(t.tick.quote)}),n.axisIndicator(),n.chart.validateData();else if("ohlc"==t.msg_type&&"undefined"==typeof t.error&&"undefined"!=typeof t.ohlc){var c=n.chart.dataSets[0].dataProvider[n.chart.dataSets[0].dataProvider.length-1],d=new Date(1e3*parseInt(t.ohlc.open_time,10)),h={date:d,open:parseFloat(t.ohlc.open),high:parseFloat(t.ohlc.high),low:parseFloat(t.ohlc.low),close:parseFloat(t.ohlc.close)};c.date.getTime()==d.getTime()?(n.chart.dataSets[0].dataProvider.pop(),n.chart.dataSets[0].dataProvider.push(h)):(a("New candle added",d),n.chart.dataSets[0].dataProvider.push(h)),n.chart.validateData()}else"undefined"!=typeof t.error&&(a("WS error",t.error),n.chart.rfc={error:t.error.message},n.$chartMessageId.text(t.error.message).show(),n.ws.close())},this.connect=function(){a("Making a new connection to WS server"),this.$chartMessageId.empty(),this.ws=new WebSocket(this.URL),this.ws.onopen=this.wsOnopen,this.ws.onmessage=this.wsOnmessage,this.ws.onclose=this.wsOnclose},this.connect()}if("undefined"==typeof RealtimeForexChartsOptions)return a("Chart options are not defined"),!1;var C=new RealtimeForexChartsOptions,y=e("#realtime-fx-chart");y.css({background:C.backgroundColor}),y.append('<div id="'+n+'"><select id="'+l+'"></select><select id="'+c+'"></select><span id="'+d+'"></span></div>'),y.append('<div id="'+p+'"><span>Loading data...</span></div>'),y.append('<div id="'+h+'"></div>');var k=e("#"+l),m=e("#"+c),b={type:"stock",glueToTheEnd:!0,dataDateFormat:"YYYY-MM-DD JJ:NN:SS",categoryAxesSettings:{minPeriod:"ss",color:C.valuesTextColor,gridColor:C.gridColor,gridThickness:C.gridColorThickness,equalSpacing:!1},balloon:{adjustBorderColor:!0,color:C.balloonTextColor,borderThickness:1,borderColor:C.balloonFillColor,fillColor:C.balloonFillColor},dataSets:[{fieldMappings:[{fromField:"open",toField:"open"},{fromField:"close",toField:"close"},{fromField:"high",toField:"high"},{fromField:"low",toField:"low"},{fromField:"value",toField:"value"}],dataProvider:[],categoryField:"date"}],panels:[{showCategoryAxis:!0,title:"Last quote",percentHeight:100,valueAxes:[{position:"right",color:C.valuesTextColor,gridColor:C.gridColor,gridThickness:C.gridColorThickness}],stockGraphs:[{id:"g1",lineThickness:C.lineThickness,balloonFunction:t,lineColor:C.lineColor,fillColors:C.lineColor,fillAlphas:1,negativeLineColor:C.negativeLineColor,negativeFillColors:C.negativeLineColor,negativeFillAlphas:1,useDataSetColors:!1}],stockLegend:{markerType:"circle",color:C.legendTextColor,valueFunction:s}}],chartScrollbarSettings:{graph:"g1",enabled:C.scrollbarEnabled,usePeriod:"mm",graphType:"smoothedLine",height:C.scrollbarHeight,position:"bottom",color:C.scrollbarTextColor,backgroundColor:C.scrollbarBackgroundColor,graphFillColor:C.scrollbarGraphFillColor,selectedBackgroundColor:C.scrollbarSelectedBackgroundColor,selectedGraphFillColor:C.scrollbarSelectedGraphFillColor,gridColor:C.scrollbarGridColor},chartCursorSettings:{valueBalloonsEnabled:!0,graphBulletSize:1,valueLineBalloonEnabled:!0,valueLineEnabled:!0,valueLineAlpha:1,cursorColor:C.cursorLineColor},periodSelector:{position:"top",inputFieldsEnabled:!1,periods:[{period:"mm",count:1,label:"1 min"},{period:"mm",count:5,label:"5 mins"},{period:"mm",count:15,label:"15 mins"},{period:"mm",count:30,label:"30 mins"},{period:"hh",count:1,label:"1 hour"},{period:"MAX",label:"MAX"}]},panelsSettings:{usePrefixes:!0},"export":{enabled:!0,position:"top-right"}},S="undefined"==typeof RealtimeForexChartsWordpressOptions?document.location.pathname:RealtimeForexChartsWordpressOptions.pluginUrl;e.getJSON(S+"config/currencies.json").done(function(e){a("Currency pairs",e),u=e,r()})})}(jQuery);